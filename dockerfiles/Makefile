DOCKERHUB_ACCOUNT := "acactown"

ALPINE_VERSION := "3.15.0"

TERRAFORM_VERSION := "1.1.3"
TFLINT_VERSION := "0.35.0"
AWS_CLI_VERSION := "1.23.1"
CONFTEST_VERSION := "0.31.0"
TERRAFORM_DOCS_VERSION := "0.16.0"
EDITORCONFIG_CHECKER_VERSION := "2.4.0"
TERRAFORM_GRAPH_BEAUTIFIER_VERSION := "0.2.0"
CHECKOV_VERSION := "2.0.1105"
TFSEC_VERSION := "1.19.1"
TERRAFORM_COMPLIANCE_VERSION := "1.3.32"
TERRASCAN_VERSION := "1.14.0"

.SHELLFLAGS = -c # Run commands in a -c flag
.SILENT: ; # no need for @
.ONESHELL: ; # recipes execute in same shell
.PHONY: build push


default: build
all: build push


build:
	cd alpine && docker build \
		--build-arg ALPINE_VERSION="${ALPINE_VERSION}" \
		--tag "${DOCKERHUB_ACCOUNT}/alpine:${ALPINE_VERSION}" .

	cd terraform && docker build \
		--build-arg BASE_IMAGE="${DOCKERHUB_ACCOUNT}/alpine:${ALPINE_VERSION}" \
		--build-arg TERRAFORM_VERSION="${TERRAFORM_VERSION}" \
		--build-arg TFLINT_VERSION="${TFLINT_VERSION}" \
		--build-arg AWS_CLI_VERSION="${AWS_CLI_VERSION}" \
		--build-arg CONFTEST_VERSION="${CONFTEST_VERSION}" \
		--build-arg TERRAFORM_DOCS_VERSION="${TERRAFORM_DOCS_VERSION}" \
		--build-arg EDITORCONFIG_CHECKER_VERSION="${EDITORCONFIG_CHECKER_VERSION}" \
		--build-arg TERRAFORM_GRAPH_BEAUTIFIER_VERSION="${TERRAFORM_GRAPH_BEAUTIFIER_VERSION}" \
		--build-arg CHECKOV_VERSION="${CHECKOV_VERSION}" \
		--build-arg TFSEC_VERSION="${TFSEC_VERSION}" \
		--build-arg TERRAFORM_COMPLIANCE_VERSION="${TERRAFORM_COMPLIANCE_VERSION}" \
		--build-arg TERRASCAN_VERSION="${TERRASCAN_VERSION}" \
		--tag "${DOCKERHUB_ACCOUNT}/terraform:${TERRAFORM_VERSION}-alpine-${ALPINE_VERSION}" .


push:
	docker push "${DOCKERHUB_ACCOUNT}/alpine:${ALPINE_VERSION}"
	docker push "${DOCKERHUB_ACCOUNT}/terraform:${TERRAFORM_VERSION}-alpine-${ALPINE_VERSION}"

